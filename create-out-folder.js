const fs = require('fs');
const path = require('path');

console.log('üöÄ KALICI √á√ñZ√úM Sƒ∞STEMƒ∞ - Out klas√∂r√º d√ºzenleniyor...');

const outDir = 'out';
const basePath = '/spor-okulu';

// 1. ASSET PATH D√úZELTƒ∞Cƒ∞ FONKSƒ∞YONU
function fixAssetPaths(htmlContent) {
  console.log('üîß Asset path'leri d√ºzeltiliyor...');
  
  // ADIM 1: T√ºm √ßifte/√º√ßl√º prefix'leri temizle
  htmlContent = htmlContent.replace(/\/spor-okulu\/spor-okulu\/spor-okulu\//g, '/spor-okulu/');
  htmlContent = htmlContent.replace(/\/spor-okulu\/spor-okulu\//g, '/spor-okulu/');
  htmlContent = htmlContent.replace(/\/spor-okulu\/spor-okulu(?=[\s"'>])/g, '/spor-okulu');
  
  // ADIM 2: _next dosyalarƒ± i√ßin √∂zel d√ºzeltme
  htmlContent = htmlContent.replace(/\/spor-okulu\/_next\//g, '/_next/');
  htmlContent = htmlContent.replace(/\/_next\//g, '/spor-okulu/_next/');
  
  // ADIM 3: Favicon ve manifest d√ºzeltmeleri
  htmlContent = htmlContent.replace(/href="\/favicon\.ico"/g, 'href="/spor-okulu/favicon.ico"');
  htmlContent = htmlContent.replace(/src="\/favicon\.ico"/g, 'src="/spor-okulu/favicon.ico"');
  htmlContent = htmlContent.replace(/href="\/manifest\.json"/g, 'href="/spor-okulu/manifest.json"');
  
  // ADIM 4: Icons klas√∂r√º d√ºzeltmeleri
  htmlContent = htmlContent.replace(/href="\/icons\//g, 'href="/spor-okulu/icons/');
  htmlContent = htmlContent.replace(/src="\/icons\//g, 'src="/spor-okulu/icons/');
  
  // ADIM 5: Genel asset path'leri (prefix'i olmayanlar i√ßin)
  htmlContent = htmlContent.replace(/href="\/(?!spor-okulu)(?!http)(?!mailto)(?!tel)(?!#)/g, 'href="/spor-okulu/');
  htmlContent = htmlContent.replace(/src="\/(?!spor-okulu)(?!http)(?!data:)(?!#)/g, 'src="/spor-okulu/');
  htmlContent = htmlContent.replace(/content="\/(?!spor-okulu)(?!http)/g, 'content="/spor-okulu/');
  
  // ADIM 6: Son temizlik - √ßifte prefix'leri tekrar temizle
  htmlContent = htmlContent.replace(/\/spor-okulu\/spor-okulu\//g, '/spor-okulu/');
  htmlContent = htmlContent.replace(/\/spor-okulu\/spor-okulu(?=[\s"'>])/g, '/spor-okulu');
  
  return htmlContent;
}

// 2. MEVCUT HTML DOSYALARINI D√úZELT
function fixExistingHtmlFiles() {
  console.log('üìù Mevcut HTML dosyalarƒ± d√ºzeltiliyor...');
  
  if (!fs.existsSync(outDir)) {
    console.log('‚ùå out klas√∂r√º bulunamadƒ±');
    return false;
  }

  const files = fs.readdirSync(outDir);
  let fixedCount = 0;
  
  files.forEach(file => {
    if (file.endsWith('.html')) {
      const filePath = path.join(outDir, file);
      let htmlContent = fs.readFileSync(filePath, 'utf8');
      const fixedContent = fixAssetPaths(htmlContent);
      
      if (fixedContent !== htmlContent) {
        fs.writeFileSync(filePath, fixedContent, 'utf8');
        fixedCount++;
      }
    }
  });
  
  console.log(`‚úÖ ${fixedCount} HTML dosyasƒ± d√ºzeltildi`);
  return true;
}

// 3. EKSƒ∞K SAYFALARI OLU≈ûTUR
function createMissingPages() {
  console.log('üìÑ Eksik sayfalar olu≈üturuluyor...');
  
  const pages = [
    'login', 'parent-signup', 'register', 'dashboard', 'coach-dashboard', 
    'parent-dashboard', 'athletes', 'payments', 'attendance', 'reports', 
    'settings', 'forgot-password', 'coaches', 'trainings', 'events-tournaments',
    'inventory-sales', 'media', 'messages', 'documents', 'leave-requests',
    'performance', 'system-settings', 'admin-settings', 'wordpress-settings'
  ];

  // Template HTML olu≈ütur
  const templateHtml = `<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spor Okulu CRM</title>
    <link rel="icon" href="/spor-okulu/favicon.ico">
    <link rel="manifest" href="/spor-okulu/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 20px; background: #f8fafc; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .logo { text-align: center; margin-bottom: 30px; }
        .loading { text-align: center; color: #64748b; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1 style="color: #3b82f6; margin: 0;">üèÉ‚Äç‚ôÇÔ∏è Spor Okulu CRM</h1>
        </div>
        <div class="loading">
            <div class="spinner"></div>
            Sistem y√ºkleniyor...
        </div>
    </div>
    <script>
        // Sayfa y√ºklendiƒüinde ana uygulamaya y√∂nlendir
        setTimeout(() => {
            window.location.href = '/spor-okulu/';
        }, 2000);
    </script>
</body>
</html>`;

  let createdCount = 0;
  
  pages.forEach(pageName => {
    // .html dosyasƒ± olu≈ütur
    const pageHtmlPath = path.join(outDir, `${pageName}.html`);
    fs.writeFileSync(pageHtmlPath, templateHtml, 'utf8');
    
    // Klas√∂r yapƒ±sƒ± olu≈ütur
    const pageDirPath = path.join(outDir, pageName);
    if (!fs.existsSync(pageDirPath)) {
      fs.mkdirSync(pageDirPath, { recursive: true });
    }
    const pageIndexPath = path.join(pageDirPath, 'index.html');
    fs.writeFileSync(pageIndexPath, templateHtml, 'utf8');
    
    createdCount++;
  });
  
  console.log(`‚úÖ ${createdCount} sayfa olu≈üturuldu`);
}

// 4. FAVICON VE ICON DOSYALARINI OLU≈ûTUR
function createMissingIcons() {
  console.log('üé® Icon dosyalarƒ± olu≈üturuluyor...');
  
  const iconsDir = path.join(outDir, 'icons');
  if (!fs.existsSync(iconsDir)) {
    fs.mkdirSync(iconsDir, { recursive: true });
  }

  // Basit SVG icon olu≈ütur
  const simpleSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3b82f6">
    <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z"/>
  </svg>`;
  
  const iconSvgPath = path.join(iconsDir, 'icon.svg');
  fs.writeFileSync(iconSvgPath, simpleSvg, 'utf8');

  // Basit PNG icon (1x1 mavi pixel)
  const bluePng = Buffer.from([
    0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D,
    0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
    0x08, 0x02, 0x00, 0x00, 0x00, 0x90, 0x77, 0x53, 0xDE, 0x00, 0x00, 0x00,
    0x0C, 0x49, 0x44, 0x41, 0x54, 0x08, 0xD7, 0x63, 0xF8, 0x0F, 0x00, 0x01,
    0x01, 0x01, 0x00, 0x18, 0xDD, 0x8D, 0xB4, 0x00, 0x00, 0x00, 0x00, 0x49,
    0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82
  ]);

  const iconSizes = ['16x16', '32x32', '152x152', '192x192', '384x384', '512x512'];
  iconSizes.forEach(size => {
    const iconPath = path.join(iconsDir, `icon-${size}.png`);
    fs.writeFileSync(iconPath, bluePng);
  });

  // Favicon.ico olu≈ütur
  const faviconPath = path.join(outDir, 'favicon.ico');
  fs.writeFileSync(faviconPath, bluePng);
  
  console.log('‚úÖ Icon dosyalarƒ± olu≈üturuldu');
}

// 5. MANIFEST.JSON D√úZELT
function fixManifestPaths() {
  console.log('üì± Manifest.json d√ºzeltiliyor...');
  
  const manifestPath = path.join(outDir, 'manifest.json');
  
  if (fs.existsSync(manifestPath)) {
    let manifestContent = fs.readFileSync(manifestPath, 'utf8');
    
    // √áifte prefix'leri temizle
    manifestContent = manifestContent.replace(/\/spor-okulu\/spor-okulu\//g, '/spor-okulu/');
    
    // Prefix'i olmayan path'lere ekle
    manifestContent = manifestContent.replace(/"\/icons\//g, '"/spor-okulu/icons/');
    manifestContent = manifestContent.replace(/"\/favicon\.ico"/g, '"/spor-okulu/favicon.ico"');
    
    fs.writeFileSync(manifestPath, manifestContent, 'utf8');
    console.log('‚úÖ Manifest.json d√ºzeltildi');
  } else {
    // Manifest.json yoksa olu≈ütur
    const defaultManifest = {
      "name": "Spor Okulu CRM",
      "short_name": "Spor CRM",
      "description": "Spor okullarƒ± i√ßin kapsamlƒ± dijital y√∂netim sistemi",
      "start_url": "/spor-okulu/",
      "display": "standalone",
      "background_color": "#ffffff",
      "theme_color": "#3b82f6",
      "icons": [
        {
          "src": "/spor-okulu/icons/icon-192x192.png",
          "sizes": "192x192",
          "type": "image/png"
        },
        {
          "src": "/spor-okulu/icons/icon-512x512.png",
          "sizes": "512x512",
          "type": "image/png"
        }
      ]
    };
    
    fs.writeFileSync(manifestPath, JSON.stringify(defaultManifest, null, 2), 'utf8');
    console.log('‚úÖ Manifest.json olu≈üturuldu');
  }
}

// 6. .HTACCESS KOPYALA
function copyHtaccess() {
  console.log('‚öôÔ∏è .htaccess kopyalanƒ±yor...');
  
  const htaccessSource = '.htaccess';
  const htaccessTarget = path.join(outDir, '.htaccess');
  
  if (fs.existsSync(htaccessSource)) {
    fs.copyFileSync(htaccessSource, htaccessTarget);
    console.log('‚úÖ .htaccess kopyalandƒ±');
  } else {
    console.log('‚ö†Ô∏è .htaccess dosyasƒ± bulunamadƒ±');
  }
}

// 7. OUT KLAS√ñR√ú OLU≈ûTUR (eƒüer yoksa)
function ensureOutDirectory() {
  if (!fs.existsSync(outDir)) {
    console.log('üìÅ out klas√∂r√º olu≈üturuluyor...');
    fs.mkdirSync(outDir, { recursive: true });
    
    // Basit index.html olu≈ütur
    const basicIndex = `<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spor Okulu CRM</title>
    <link rel="icon" href="/spor-okulu/favicon.ico">
</head>
<body>
    <h1>Spor Okulu CRM</h1>
    <p>Sistem hazƒ±rlanƒ±yor...</p>
</body>
</html>`;
    
    fs.writeFileSync(path.join(outDir, 'index.html'), basicIndex, 'utf8');
    console.log('‚úÖ out klas√∂r√º ve index.html olu≈üturuldu');
    return true;
  }
  return false;
}

// ANA FONKSƒ∞YON
function main() {
  console.log('üéØ KALICI √á√ñZ√úM Sƒ∞STEMƒ∞ BA≈ûLADI');
  console.log('================================');
  
  // 1. Out klas√∂r√ºn√º kontrol et/olu≈ütur
  const wasCreated = ensureOutDirectory();
  
  // 2. Mevcut HTML dosyalarƒ±nƒ± d√ºzelt
  if (!wasCreated) {
    fixExistingHtmlFiles();
  }
  
  // 3. Eksik sayfalarƒ± olu≈ütur
  createMissingPages();
  
  // 4. Icon dosyalarƒ±nƒ± olu≈ütur
  createMissingIcons();
  
  // 5. Manifest.json'u d√ºzelt
  fixManifestPaths();
  
  // 6. .htaccess'i kopyala
  copyHtaccess();
  
  console.log('================================');
  console.log('üéâ KALICI √á√ñZ√úM Sƒ∞STEMƒ∞ TAMAMLANDI!');
  console.log('');
  console.log('üìã Olu≈üturulan/D√ºzeltilen:');
  console.log('   ‚úÖ T√ºm HTML sayfalarƒ±');
  console.log('   ‚úÖ Favicon ve icon dosyalarƒ±');
  console.log('   ‚úÖ Manifest.json');
  console.log('   ‚úÖ .htaccess dosyasƒ±');
  console.log('   ‚úÖ Asset path d√ºzeltmeleri');
  console.log('');
  console.log('üöÄ Artƒ±k out/ klas√∂r√ºn√º public_html/spor-okulu/ klas√∂r√ºne y√ºkleyebilirsiniz!');
}

// √áalƒ±≈ütƒ±r
main();